
<%= form_tag '', :method => :post do %>
  <div class="field">
  	<%= label_tag :query, "Запрос" %>
    <%= text_field_tag :query, params[:query] %>
  </div>
  <div class="field">
    <%= radio_button_tag(:stimulreaction, "stimul", (params[:stimulreaction] ||= "stimul" ) == "stimul") %>
    <%= label_tag(:stimul, "Стимул") %>
    <%= radio_button_tag(:stimulreaction, "reaction", params[:stimulreaction] == "reaction") %>
    <%= label_tag(:reaction, "Реакция") %>
  </div>
  <div class="field">
  	<%= label_tag :age_start, "Возраст от" %>
  	<%= select_tag(:age_start, options_for_select((10..100).to_a, params[:age_start])) %>
  	<%= label_tag :age_end ,"до" %>
  	<%= select_tag(:age_end, options_for_select((10..100).to_a, params[:age_end] ||= 100)) %>
  </div>
  <div class="field">
  	<%= label_tag :specialty, "Профессия" %>
  	<%= select_tag(:specialty, 
  	options_for_select([["Все",nil]] + Specialty.all.collect { |u| [u.specialty, u.id] }, params[:specialty])) %>
  </div>
  <div class="field">
    <%= radio_button_tag(:sex, "all", (params[:sex] ||= "all" ) == "all") %>
    <%= label_tag(:all, "Все") %>
    <%= radio_button_tag(:sex, "man", params[:sex] == "man") %>
    <%= label_tag(:man, "Женщины") %>
    <%= radio_button_tag(:sex, "woman", params[:sex] == "woman") %>
    <%= label_tag(:woman, "Мужчины") %>
    <%= radio_button_tag(:sex, "diff", params[:sex] == "diff") %>
    <%= label_tag(:diff, "Сравнить") %>
  </div>
  <div class="field">
  	<%= label_tag :sort, "Сортировка" %>
    <%= radio_button_tag(:sort, "freq", (params[:sort] ||= "freq" ) == "freq") %>
    <%= label_tag(:freq, "По частоте") %>
    <%= radio_button_tag(:sort, "abc", params[:sort] == "abc") %>
    <%= label_tag(:abc, "По алфавиту") %>
  </div>
  <div class="field">
  	<%= check_box_tag(:normalization,  true , params[:normalization].present?) %>
	<%= label_tag(:normalization, "Включить нормализацию по частоте") %>
  </div>


  <%= submit_tag 'Поиск' %>
<% end %>

<% if @stimul.present? and params[:sex] != "diff" %>
  <div id="stimul">
  	<h3>Статистика по запросу:</h3>
всего реакций на стимул "<%= @stimul.stimul %>" : <%= @stimulreaction_fd.rows.count %>
	<br>
  	
  </div>




<table>
  <thead>
    <tr>
      <th>Реакции</th>
      <th><%=  params[:normalization].present? ? "Частота" : "Число" %></th>
    </tr>
  </thead>

  <tbody>
    <% @stimulreaction_fd.rows.each do |f| %>
      <tr>
        <td><%= Reaction.find(f[0]).reaction rescue nil %></td>
        <% df=""
        if params[:sex] == "all"
          df = f[1]
          df = (f[1].to_d/@stimulreaction_fd.rows.count*100).round  if (params[:normalization].present? and f[1].present?)
        elsif params[:sex] == "woman"
          df = f[2]
          df = (f[2].to_d/@stimulreaction_fd.rows.count*100).round  if (params[:normalization].present? and f[2].present?)
        elsif params[:sex] == "man"
          df = f[3]
          df = (f[3].to_d/@stimulreaction_fd.rows.count*100).round  if (params[:normalization].present? and f[3].present?)
        else
          df = f[1]
          df = (f[1].to_d/@stimulreaction_fd.rows.count*100).round  if (params[:normalization].present? and f[1].present?)
        end
         %>
        <td><%= df %></td>
      </tr>
    <% end %>
  </tbody>
</table>
<% end %>

<% if @reaction.present? %>
  <div id="reaction">
  	<%= @reaction.reaction %>
  </div>
<% end %>

<% if @stimul.present? and params[:sex] == "diff" %>
 <table>
 <thead>
    <tr>
      <th>Реакции</th>
      <th>Частота</th>
      <th>Муж</th>
      <th>Жен</th>
    </tr>
  </thead>
    <tbody>
     <% @stimulreaction_fd.rows.each do |f| %>
      <tr>
        <td><%= Reaction.find(f[0]).reaction rescue nil %></td>
        <td><%= (params[:normalization].present? and f[1].present?)? (f[1].to_d/@stimulreaction_fd.rows.count*100).round : f[1]  %></td>
        <td><%= (params[:normalization].present? and f[2].present?)? (f[2].to_d/@stimulreaction_fd.rows.count*100).round : f[2]  %></td>
        <td><%=(params[:normalization].present? and f[3].present?)? (f[3].to_d/@stimulreaction_fd.rows.count*100).round : f[3]  %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<% end %>
